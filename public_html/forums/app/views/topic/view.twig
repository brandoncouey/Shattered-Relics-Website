{%  extends 'layout.twig' %}

{% block content %}

{% set avatar = 
    topic.avatar_url
    ? url(topic.avatar_url, false)
    : url("public/img/user.jpg")
%}

{% set caturl = friendlyTitle(curcat.parent~'-'~curcat.title) %}
{% set topic_url = 'topic/view/'~friendlyTitle(topic.id~'-'~topic.title) %}

<div class="container">
    <div class="row mb-5">
        <div class="col-sm-12 col-lg-12">
            <div class="mb-3 text-right">
                <a href="{{ url(caturl) }}" class="btn btn-dark ">Back to Discussions</a>
            </div>
            
            <div class="d-flex">
                <div class="flex-fill pr-3">
                    <div class="user_avatar large" style="background-image:url('{{ avatar }}');">
                        {% if topic.last_visit %}
                        <div class="user-online bg-success"></div>
                        {% endif %}
                    </div>
                </div>

                <div class="flex-fill w-100">
                    <div class="card border-0 shadow-sm mb-3 reply-card">
                        <div class="card-body">

                            <div class="d-flex align-items-center border-bottom pb-3 mb-3">

                                <div class="flex-fill">
                                    {% if topic.rank == "admin" %}
                                    <i class="fal fa-crown"></i>
                                    {% endif %}
                                    <strong>{{ topic.username|capitalize }}</strong>
            
                                    <small class="text-muted">
                                        {{ elapsed(topic.started) }}
                                    </small>
                                </div>

                                <div class="flex-fill text-right">
                                    {% include 'topic/topic_options.twig' %}
                                </div>
                            </div>
        
                            {{ purifier.purify(topic.topic_body)|raw }}

                            <div class="user-options mt-5">
                                {% include 'topic/topic_options.twig' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            {% for reply in replies.items() %}

            {% set reply_avatar = 
                reply.avatar_url
                ? url(reply.avatar_url, false)
                : url("public/img/user.jpg")
            %}
            
            <div class="d-flex">
                <div class="flex-fill pr-3">
                    <div class="user_avatar large" 
                        style="background-image:url('{{ reply_avatar }}');">
                        {% if reply.last_visit %}
                        <div class="user-online bg-success"></div>
                        {% endif %}
                    </div>
                </div>

                <div class="flex-fill w-100">
                    <div class="card border-0 shadow-sm mb-3 reply-card">
                        <div class="card-body">
                            
                            <div class="mb-3 border-bottom pb-3">
                                {% if reply.rank == "admin" %}
                                <i class="fal fa-crown"></i>
                                {% endif %}
                                <strong>{{ reply.username|capitalize }}</strong>
        
                                <small class="text-muted">
                                    {{ elapsed(reply.posted) }}
                                </small>
                            </div>
        
                            {{ purifier.purify(reply.body)|raw }}

                            <div class="user-options mt-5">
                                {% if user is defined %}
                                    {#
                                    {% if user.id == topic.author %}
                                    <a class="btn btn-link p-1 text-{{ dark_mode ? 'light' : 'dark' }}"
                                        href="{{ url('topic/edit/'~topic.id) }}">
                                        Edit
                                    </a>
                                    {% endif %}
                                    #}

                                    {% if user.isModerator() %}
                                    <a class="btn btn-link p-1 text-{{ dark_mode ? 'light' : 'dark' }}"
                                        href="{{ url(topic_url~'?delreply='~reply.id) }}">
                                        Delete
                                    </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            
            {% if replies is defined %}


            <nav aria-label="servernav" class="my-5">
                <ul class="pagination justify-content-center pagination-lg">
                    <li class="page-item {{ replies.onFirstPage() ? 'disabled' : '' }}">
                        <a class="page-link"
                             href="{{ url(topic_url~'/'~'1') }}" tabindex="-1">
                            <i class="fal fa-angle-double-left"></i>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>

                    <li class="page-item {{ replies.onFirstPage() ? 'disabled' : '' }}">
                        <a class="page-link" 
                            href="{{ url(topic_url~'/'~(replies.currentPage() == 1 ? 1 : replies.currentPage() - 1)) }}" tabindex="-1">
                            <i class="fal fa-angle-left"></i>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>

                    <li class="page-item disabled">
                        <a class="page-link" href="#">
                            {{ replies.currentPage() }}
                        </a>
                    </li>

                    <li class="page-item {{ replies.currentPage() >= replies.lastPage() ? 'disabled' : '' }}">
                        <a class="page-link" 
                            href="{{ url(topic_url~'/'~(replies.currentPage() == replies.lastPage() ? replies.lastPage() : replies.currentPage() + 1)) }}">
                            <i class="fal fa-angle-right"></i>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>

                    <li class="page-item {{ replies.currentPage() >= replies.lastPage() ? 'disabled' : '' }}">
                        <a class="page-link" 
                            href="{{ url(topic_url~'/'~replies.lastPage()) }}">
                            <i class="fal fa-angle-double-right"></i>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <hr>
            {% endif %}

            {% if user is defined and topic['state'] == 0 %}
            {% include 'topic/replybox.twig' %}
            {% endif %}

            {% if topic['state'] == 1 %}
            <div class="alert alert-light">
                This topic is not open for further replies.
            </div>
            {% endif %}
            
            {{ content|raw }}
        </div>

    </div>
</div>
{%  endblock %}
