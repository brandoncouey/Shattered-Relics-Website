{%  extends 'admin_layout.twig' %}

{% block content %}
{% include 'admin/sidebar.twig' %}

<div class="main-content" id="panel">
    {% include "admin/header.twig" %}

    <div class="container-fluid">
        <!-- Card stats -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-transparent">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase text-muted ls-1 mb-1">Admin</h6>
                                <h2 class="mb-0">User Management</h2>
                            </div>
                            <div class="col justify-content-end">
                                <form action="{{ url('admin/users') }}" method="get" class="form-inline float-right">
                                    <div class="form-group">
                                        <input class="form-control" placeholder="Search..." name="username">
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-link text-white">
                                            <i class="fal fa-search"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>username</th>
                                <th>Rank</th>
                                <th>Last Login</th>
                                <th>Created</th>
                                <th></th>
                            </tr>
                        </thead>
                        {% for user in users.items() %}
                        <tr>
                            <td style="width:60px;" class="text-center">
                                {{ user.id }}
                            </td>
                            <td>
                                <span class="text-white-50">{{ user.username|capitalize }}</span><br>
                                <small>{{ user.email }}</small>
                            </td>
                            <td>{{ user.rank }}</td>
                            <td>
                                {% if user.last_login != -1 %}
                                {{ user.last_login|date("m.d.y G:i") }}
                                {% endif %}<br>
                                <small>{{ user.last_ip }}</small>
                            </td>
                            <td>
                               {{ user['created']|date("m.d.y") }}
                            </td>
                            <td class="text-right">
                                <div class="dropdown">
                                    <button class="btn btn-link text-white btn-sm dropdown-toggle" 
                                        type="button" id="dropdownMenuButton" 
                                        data-toggle="dropdown" 
                                        aria-haspopup="true" 
                                        aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                        <div class="dropdown-header text-muted">Ranks</div>
                                        <a class="dropdown-item" href="{{ url('admin/users?rank=member&id='~user.id) }}">
                                            Member
                                        </a>
                                        <a class="dropdown-item" href="{{ url('admin/users?rank=moderator&id='~user.id) }}">
                                            Moderator
                                        </a>
                                        <a class="dropdown-item" href="{{ url('admin/users?rank=admin&id='~user.id) }}">
                                            Admin
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-header text-muted">
                                            Actions
                                        </div>
                                        {% if user.rank == "banned" %}
                                        <a class="dropdown-item" href="?ban={{ user.id }}">
                                           Lift Ban
                                        </a>
                                        {% else %}
                                        <a class="dropdown-item" href="?ban={{ user.id }}">
                                            Ban
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

               
                {% set totalPages = users.lastPage() %}
                {% set current = users.currentPage() %}

                {% set pageUrl = username is defined    
                    ? '?username='~username 
                    : '' %}

                <nav aria-label="servernav" class="my-5">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {{ users.onFirstPage() ? 'disabled' : '' }}">
                            <a class="page-link"
                                 href="{{ url('admin/users/1'~pageUrl) }}" tabindex="-1">
                                <i class="fal fa-angle-double-left"></i>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                
                        <li class="page-item {{ users.onFirstPage() ? 'disabled' : '' }}">
                            <a class="page-link" 
                                href="{{ url('admin/users/'~(current == 1 ? 1 : current - 1) ~ pageUrl) }}" tabindex="-1">
                                <i class="fal fa-angle-left"></i>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                
                        {% if totalPages > 5 %}
                            {% set start = current < 3 ? 1 : current - 2 %}
                            {% set end   = start < 4 ? start + 4 : current + 2 %}
                
                            {% if end > totalPages %}
                                {% set end = totalPages %}
                            {% endif %}
                
                            {% if start + 4 >= totalPages %}
                                {% set start = totalPages - 4 %}
                            {% endif %}
                        {% else %}
                            {% set start = 1 %}
                            {% set end   = users.lastPage() %}
                        {% endif %}
                
                        {% for p in start..end %}
                        <li class="page-item {{ current == p ? ' active' : ''}}">
                            <a class="page-link" href="{{ url('admin/users/' ~ p ~ pageUrl) }}">
                                {{ p }}
                            </a>
                        </li>
                        {% endfor %}
                
                        <li class="page-item {{ current >= totalPages ? 'disabled' : '' }}">
                            <a class="page-link" 
                                href="{{ url('admin/users/'~(current == totalPages ? totalPages : current + 1) ~ pageUrl) }}">
                                <i class="fal fa-angle-right"></i>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                
                        <li class="page-item {{ current >= totalPages ? 'disabled' : '' }}">
                            <a class="page-link" 
                                href="{{ url('admin/users/'~ totalPages ~ pageUrl) }}">
                                <i class="fal fa-angle-double-right"></i>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    </ul>
                </nav>

            </div>
        </div>
        {{ content|raw }}
    </div>
</div>
{% endblock %}